---
title: "え!!Slackに潤いを与えるSlackbotをGASで!?"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["GoogleAppsScript", "Slackbot"]
published: false
---

できらぁ!!(なおアドカレには遅刻)

# はじめに

この記事は「プロもくチャット Advent Calendar 2023」11/25日目の記事です📚
https://qiita.com/advent-calendar/2023/puromoku

# Slackbot、してますか

世のプログラマが日夜入りびたる場所、Slack。
彼ら/彼女らを惹きつけてやまないSlackには至高のおもちゃ「Slackbot」が幅を利かせているという。
我々スタッフは事実を確かめるべく、魑魅魍魎が跋扈するSlackの奥地へと歩を進めるのであった―――

## Slackbotとは
冒頭で疲れたので普通に書きます。
チームメンバなどと日々のコミュニケーションを取るためにSlackは不可欠です。
しかし皆さんはこう思ったことはないでしょうか。

**混沌が足りない**

と。

:::message
個人の感想です。
:::

そんな殺伐としたSlackに颯爽と現れたのがタイトルにもあります「Slackbot」になるわけです。
Slackでは投稿やチャンネル作成などのイベントがあると、所定の場所にPOSTリクエストを投げて知らせてくれる機能があるため、これを~~悪用~~活用することによってSlackの治安維持に役立てることができます。

ちなみに、通常Slackbotと言った場合はSlack標準で自動メッセージやリマインダなどの時に出てくるコイツ↓のことを指しますが、
![slackbotくん](https://a.slack-edge.com/80588/marketing/img/avatars/slackbot/avatar-slackbot@2x.png =100x)
*Slackbotくん(公式)*

今回の記事では投稿に反応して所定の返答をする自作野良アプリのことをSlacbotということにします。
(広義のChatbotといった方がよさそうな気もする)

## 実例

実際にプロもくのSlackにて稼働しているイメージをいくつか持って来てみました。
解説用に作成したため委細は異なりますことご承知おきください。

# Slackbotサーバをつくる

このPOSTリクエストを受け取ってSlack側に多種多様な投稿をするBotを作るにあたって、サーバが必要不可欠となります。
ただですよ。Slackbotのためだけにサーバをガチで用意するのもなかなかに骨が折れますので、
ここはプログラマの懐刀**GAS**に登場していただくことにいたしましょう。

## 今回の環境,方針

ということで今回使用するものがこちら

- aside
- Github Actions 

asideはclaspでGASをTS管理するやつですね。
PRがマージされたタイミングで自動でGASにプッシュされるようにしていきます。
というのも、今回は複数人で開発する想定でいるため、ある程度Github側で進められるようにしたかった事情があります。
ちなみに今回の記事の内容ではGAS側にトランスパイルされたコードがプッシュされますが、実際にWebアプリとして使えるようにデプロイするのは手動になります。
この辺はActionsにclaspのコマンドを追加すれば一気通貫でWebアプリデプロイまでいけるのですが、今のところはPRと同じタイミングでなくてもいいかと思ったため手動のままとしています。

## 手順

ではざっくり手順です。
コマンドやら細々した部分はUI変更などで陳腐化しそうなので大まかな流プロジェクトれの未記載します。画像なども同様。~~スクショ撮りまくるのが大変なのが7割なんですが。~~

1. GoogleAppsScriptAPIを有効にする
2. asideのコマンドでGASプロジェクトを生成
3. GASのコードを書く
4. claspでGASにコードをpush
5. GASでWebアプリをデプロイ

やっていることを大まかにいうと、まずGASでWebアプリを公開することでPOSTリクエストを受け取れるエンドポイントを作ります。
そのエンドポイントにSlackからチャット投稿などのイベントを都度GASアプリに投げる設定をし、GASでSlackAPIを叩いてbotからの反応を返す、という流れです。

順番に見ていきます

### 1. GoogleAppsScriptAPIを有効にする
GASを使ったことがない場合はoffになっているかも。
アカウントに適用されるので1回onにすればOK

https://script.google.com/home/usersettings

### 2. asideのコマンドでGASプロジェクトを生成

[aside](https://github.com/google/aside)を使ってGASのプロジェクトを新規作成しましょう。
基本はリポジトリのREADMEにあるGetting Startedの通りに。

```bash
$ npx @google/aside init
```

リポジトリ作成のほか、デフォルトでGoogle Driveに新規のSpread Sheetが生成されます。
このスプシーにGoogle Apps Scriptが紐づいていて、ここに対して今から書くコードをトランスパイル&プッシュしていくことになります。
スプシーについてはGASで使いたいデータの永続化にちょうどいいので、デフォのままで作成することをお勧めします。
ただ、あくまで表からのデータ取得になるので標準ライブラリで取り廻すのは少々面倒です。そんな時にはアドカレのこちらの記事を参考にしてORMを併用してみてもよいと思います(ダイレクトマーケティング)。

### 3. GASのコードを書く
さてGASのコードを書きます。
GASではグローバルにdoPostやdoGetなど所定のメソッドを定義することで、Webアプリとしてデプロイした際にHTTPリクエストを処理させることができます。

4. claspでGASにコードをpush
5. GASでWebアプリをデプロイ
